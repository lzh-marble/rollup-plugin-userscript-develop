import e from"path";import{parse as n}from"@babel/parser";import t from"@babel/traverse";import r from"@babel/generator";import*as o from"@babel/types";function i(e){const n=o.program([],[],"script");return o.addComment(n,"inner","==UserScript==",!0),(null==e?void 0:e.length)&&o.addComments(n,"inner",e),o.addComment(n,"inner","==/UserScript==",!0),n}function s(s){let m=[];return{name:"rollup-plugin-userscript-responsive-develop",transform(e){let{metaCommentArr:o,script:i}=function(e){const o=n(e,{sourceType:"unambiguous"}),i=e=>"CommentLine"==e.type&&e.value.includes("==UserScript=="),s=e=>"CommentLine"==e.type&&e.value.includes("==/UserScript==");return{metaCommentArr:function(e){let n=[];function r(e){if(e)for(;e.length;){const t=e.findIndex(i),r=e.findIndex(s);if(-1==t||-1==r)break;let o=e.splice(t,r-t+1);o.shift(),o.pop(),n=n.concat(o)}}return t(e,{enter(e){r(e.node.leadingComments),r(e.node.trailingComments)}}),n}(o),script:r(o)}}(e);return m=[...m,...o],{code:i.code,map:i.map}},generateBundle(t,a){Object.values(a).forEach((a=>{if("chunk"===a.type)if(null!=s&&s.extractToHeader){if(m.length){const e=i(m);e.body.push(...n(a.code).program.body);const{code:t,map:o}=r(e,{inputSourceMap:a.map,sourceMaps:!0});a.code=t,a.map=function(e,n){return n?Object.assign(e,{names:n.names,mappings:n.mappings,sourcesContent:n.sourcesContent}):e}(a.map,o)}}else{const n=function(e,n){if(n){e||(e=o.program([],[],"script"),o.addComment(e,"inner"," ==UserScript==",!0),o.addComment(e,"inner"," ==/UserScript==",!0));const t=` @require file://${n}`;o.addComment(e,"inner",t,!0);const r=e.innerComments.splice(e.innerComments.length-1,1)[0];return e.innerComments.splice(e.innerComments.length-1,0,r),e}}(i(m),e.resolve(process.cwd(),t.file));this.emitFile({type:"asset",fileName:(null==s?void 0:s.name)??`debug.${t.file}$`,source:r(n).code})}}))}}}export{s as default};
